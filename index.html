
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>é¡”è¨ºæ–­AI</title>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; }
    img { max-width: 100%; height: auto; margin: 10px 0; }
    #result { margin-top: 10px; font-size: 18px; }
    .loading { font-style: italic; color: gray; }
  </style>
</head>
<body>
  <h2>ğŸ“· å†™çœŸã‚’é¸ã¶ã ã‘ã§è¨ºæ–­ï¼</h2>
  <input type="file" id="imageUpload" accept="image/*"><br>
  <div id="status" class="loading">ğŸ”„ ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  <img id="preview" src="" style="display:none;">
  <div id="result"></div>

  <script>
    const MODEL_URL = "https://levorg-wrx.github.io/face-api-host/models";

    Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL)
        .then(() => console.log("âœ… ssdMobilenetv1 èª­ã¿è¾¼ã¿æˆåŠŸ"))
        .catch(e => console.error("âŒ ssdMobilenetv1 èª­ã¿è¾¼ã¿å¤±æ•—", e)),

      faceapi.nets.ageGenderNet.loadFromUri(MODEL_URL)
        .then(() => console.log("âœ… ageGenderNet èª­ã¿è¾¼ã¿æˆåŠŸ"))
        .catch(e => console.error("âŒ ageGenderNet èª­ã¿è¾¼ã¿å¤±æ•—", e)),

      faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
        .then(() => console.log("âœ… faceExpressionNet èª­ã¿è¾¼ã¿æˆåŠŸ"))
        .catch(e => console.error("âŒ faceExpressionNet èª­ã¿è¾¼ã¿å¤±æ•—", e))
    ]).then(() => {
      document.getElementById('status').textContent = 'ğŸ“‚ ç”»åƒã‚’é¸ã‚“ã§ã­';
    }).catch(() => {
      document.getElementById('status').textContent = 'âŒ ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
    });

    document.getElementById('imageUpload').addEventListener('change', async (event) => {
      const imgFile = event.target.files[0];
      if (!imgFile) return;

      const img = document.getElementById('preview');
      img.src = URL.createObjectURL(imgFile);
      img.style.display = 'block';
      document.getElementById('status').textContent = 'ğŸ§  è¨ºæ–­ä¸­â€¦';
      document.getElementById('result').innerHTML = '';

      await img.onload;

      try {
        const detection = await faceapi
          .detectSingleFace(img)
          .withAgeAndGender()
          .withFaceExpressions();

        if (!detection) {
          document.getElementById('status').textContent = 'ğŸ˜¢ é¡”ãŒæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ';
          return;
        }

        const age = Math.round(detection.age);
        const gender = detection.gender === 'male' ? 'ç”·æ€§' : 'å¥³æ€§';
        const expressions = detection.expressions;
        const topExpression = Object.entries(expressions).sort((a, b) => b[1] - a[1])[0][0];

        const funnyComment = getFunnyComment(age, gender, topExpression);

        document.getElementById('status').textContent = 'âœ… è¨ºæ–­å®Œäº†ï¼';
        document.getElementById('result').innerHTML = `
          <p>ğŸ§“ å¹´é½¢: ${age}æ­³</p>
          <p>ğŸš» æ€§åˆ¥: ${gender}</p>
          <p>ğŸ˜„ è¡¨æƒ…: ${topExpression}</p>
          <p>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆ: ${funnyComment}</p>
        `;
      } catch (err) {
        console.error("âŒ è¨ºæ–­ã‚¨ãƒ©ãƒ¼:", err);
        document.getElementById('status').textContent = 'âŒ è¨ºæ–­ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
      }
    });

    function getFunnyComment(age, gender, expression) {
      const base = `${gender}ã§${age}æ­³ã€${expression}ãªè¡¨æƒ…ã§ã™ã­ï¼`;
      const extras = {
        happy: 'ä»Šæ—¥ã„ã„ã“ã¨ã‚ã‚Šã¾ã—ãŸï¼ŸğŸ˜„',
        angry: 'æ€’ã£ã¦ã‚‹ï¼Ÿè½ã¡ç€ã„ã¦â˜•ï¸',
        sad: 'å…ƒæ°—å‡ºã—ã¦ï¼ğŸŒˆ',
        surprised: 'ä½•è¦‹ãŸã®!?ğŸ˜²',
        neutral: 'ã¾ã‚‹ã§AIã®ã‚ˆã†ãªç„¡è¡¨æƒ…ğŸ¤–',
        fearful: 'ãƒ“ã‚¯ãƒ“ã‚¯ã—ã¦ã‚‹â€¦ğŸ‘»',
        disgusted: 'ä½•ã‹ã‚¤ãƒ¤ãªã‚‚ã®è¦‹ãŸï¼ŸğŸ’©'
      };
      return base + ' ' + (extras[expression] || '');
    }
  </script>
</body>
</html>
